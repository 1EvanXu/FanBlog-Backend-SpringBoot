<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.evan.blog.repository.ArticleDao">
    <resultMap id="articleMap" type="article">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="createdTime" column="created_time"/>
        <result property="latestEditedTime" column="latest_edited_time"/>
        <result property="status" column="status" typeHandler="com.evan.blog.repository.typehandlers.ArticleStatusTypeHandler"/>
        <result property="htmlContent" column="html_content"/>
        <result property="markdownContent" column="md_content"/>
    </resultMap>

    <sql id="articleAbstract">
        select id, title, created_time, latest_edited_time, status from articles
    </sql>

    <select id="selectAllArticles" parameterType="articleQueryFilter" resultMap="articleMap">
        <include refid="articleAbstract"/>
        <where>
            <if test="articleStatus != null">status=#{articleStatus}</if>
        </where>
        <if test="orderField != null and orderField != ''">order by #{orderField}
          <choose>
              <when test="order.name() == 'Asc'">ASC</when>
              <otherwise>DESC</otherwise>
          </choose>
        </if>
    </select>

    <select id="selectArticleById" parameterType="int" resultMap="articleMap">
        select * from articles where id=#{id};
    </select>

    <select id="selectArticlesCount" resultType="int">
        select count(*) from articles;
    </select>

    <insert id="insertArticle" parameterType="article" useGeneratedKeys="true" keyProperty="id">
        insert into articles(title, status, html_content, md_content)
        values (#{title}, #{status}, #{htmlContent}, #{markdownContent});
    </insert>
    <update id="updateArticleStatus">
        update articles set status=#{statusCode} where id=${id};
    </update>
    <update id="updateArticle" parameterType="article">
        update articles
        <set>
            <if test="title != null and title != ''">title=#{title},</if>
            <if test="status != null">status=#{status},</if>
            <if test="htmlContent">html_content=#{htmlContent},</if>
            <if test="markdownContent">md_content=#{markdownContent}</if>
        </set>
        where id=#{id};
    </update>
    <delete id="deleteArticle" parameterType="int">
        delete from articles where id=#{id};
    </delete>
</mapper>